<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: "Cairo", sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); color: white; min-height: 100vh; }
    .login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .login-screen.hidden { display: none; }
    .login-box { background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; border: 1px solid rgba(255,255,255,0.2); text-align: center; width: 100%; max-width: 350px; }
    .login-box h1 { font-size: 2.5rem; margin-bottom: 15px; background: linear-gradient(90deg, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .login-box p { font-size: 1rem; margin-bottom: 20px; opacity: 0.9; }
    .pwd-group { display: flex; gap: 10px; margin-bottom: 20px; }
    .pwd-group input { flex: 1; padding: 12px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; border-radius: 8px; font-size: 1rem; }
    .pwd-group input::placeholder { color: rgba(255,255,255,0.6); }
    .pwd-group input:focus { outline: none; border-color: #FFD700; background: rgba(255,255,255,0.2); }
    .toggle-btn { padding: 12px 15px; background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,165,0,0.3)); border: 2px solid rgba(255,255,255,0.3); color: #FFD700; cursor: pointer; font-size: 1.1rem; border-radius: 8px; }
    .toggle-btn:hover { background: linear-gradient(135deg, rgba(255,215,0,0.5), rgba(255,165,0,0.5)); }
    .login-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; }
    .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255,215,0,0.4); }
    .error-msg { color: #FF6B6B; font-size: 0.9rem; margin-top: 10px; min-height: 20px; }
    .main-screen { display: none; padding: 20px; }
    .main-screen.visible { display: block; }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { font-size: 2.5rem; background: linear-gradient(90deg, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
    .stats { display: flex; gap: 15px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; }
    .stat { background: rgba(255,255,255,0.15); border: 2px solid #FFD700; padding: 20px 30px; border-radius: 10px; text-align: center; min-width: 150px; }
    .stat-num { font-size: 2.5rem; font-weight: 900; color: #FFD700; }
    .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .section { background: rgba(255,255,255,0.15); border-radius: 15px; padding: 20px; border: 1px solid rgba(255,255,255,0.2); }
    .section h2 { font-size: 1.5rem; color: #FFD700; margin-bottom: 15px; }
    #wheel { width: 100%; max-width: 300px; height: 300px; margin: 0 auto; border-radius: 50%; border: 8px solid #FFD700; background: conic-gradient(#FF6B6B, #4ECDC4, #FFE66D, #95E1D3, #FF8C42, #A8E6CF); position: relative; }
    .pointer { width: 15px; height: 25px; background: #FFD700; clip-path: polygon(30% 0%, 70% 0%, 100% 100%, 0% 100%); position: absolute; top: -20px; left: 50%; transform: translateX(-50%); z-index: 10; }
    .segment { position: absolute; width: 100%; height: 100%; display: flex; align-items: flex-start; justify-content: center; transform-origin: 50% 50%; padding-top: 20px; }
    .segment span { font-size: 12px; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); max-width: 50px; text-align: center; }
    .winner-box { background: linear-gradient(135deg, rgba(255,107,107,0.9), rgba(255,165,0,0.9)); border-radius: 10px; padding: 15px; margin-top: 15px; border: 2px solid #FFD700; display: none; text-align: center; }
    .winner-box.show { display: block; }
    .winner-name { font-size: 1.8rem; font-weight: 900; color: #FFD700; margin: 10px 0; }
    .input-box { display: flex; gap: 8px; margin-bottom: 10px; }
    input[type="text"] { flex: 1; padding: 10px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; border-radius: 8px; }
    input[type="text"]:focus { outline: none; border-color: #FFD700; background: rgba(255,255,255,0.2); }
    button { padding: 10px 15px; border: none; border-radius: 8px; font-family: inherit; font-weight: bold; cursor: pointer; }
    .btn-add { background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; flex: 0.6; }
    .btn-file { flex: 1; background: linear-gradient(135deg, #A8E6CF, #56CCF2); color: white; font-size: 0.9rem; }
    .btn-clear { width: 100%; background: linear-gradient(135deg, #FF6B6B, #FF8C42); color: white; margin: 10px 0; }
    .btn-spin { width: 100%; background: linear-gradient(135deg, #4ECDC4, #44A08D); color: white; padding: 12px; font-size: 1rem; margin-top: 15px; }
    .players-list { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; max-height: 200px; overflow-y: auto; margin: 10px 0; }
    .player-item { background: rgba(255,215,0,0.1); padding: 10px; margin: 5px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #FFD700; }
    .delete-btn { background: #FF6B6B; color: white; padding: 5px 10px; font-size: 0.8rem; }
    .slider-box { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin: 15px 0; }
    input[type="range"] { width: 100%; cursor: pointer; }
    .duration-text { text-align: center; font-size: 1.5rem; color: #FFD700; font-weight: bold; margin-bottom: 10px; }
    .msg { padding: 10px; border-radius: 8px; margin: 10px 0; font-weight: bold; }
    .msg.success { background: rgba(78,205,196,0.3); border-left: 4px solid #4ECDC4; }
    .msg.error { background: rgba(255,107,107,0.3); border-left: 4px solid #FF6B6B; }
    @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h1>ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
      <p>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
      <div class="pwd-group">
        <input type="password" id="pwd" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="off">
        <button class="toggle-btn" id="togglePwd">ğŸ‘ï¸</button>
      </div>
      <button class="login-btn" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
      <div class="error-msg" id="errorMsg"></div>
    </div>
  </div>
  <div class="main-screen" id="mainScreen">
    <div class="header">
      <h1>ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
      <p style="opacity: 0.9;">Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø­Ø¸ Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©</p>
    </div>
    <div class="stats">
      <div class="stat">
        <div>ğŸ‘¥ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</div>
        <div class="stat-num" id="viewers">0</div>
      </div>
      <div class="stat">
        <div>ğŸ® Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</div>
        <div class="stat-num" id="players">0</div>
      </div>
    </div>
    <div class="container">
      <div class="section">
        <h2>ğŸ¡ Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸</h2>
        <div id="wheel"><div class="pointer"></div></div>
        <div class="winner-box" id="winnerBox">
          <div>ğŸ† Ø§Ù„ÙØ§Ø¦Ø² ğŸ†</div>
          <div class="winner-name" id="winnerName">-</div>
        </div>
      </div>
      <div class="section">
        <h2>âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h2>
        <div class="input-box">
          <input type="text" id="playerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">
          <button class="btn-add" id="addBtn">â•</button>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="btn-file" id="exportBtn">ğŸ“¥ ØªØµØ¯ÙŠØ±</button>
          <button class="btn-file" id="importBtn">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
        </div>
        <input type="file" id="fileInput" accept=".txt" style="display: none;">
        <div class="players-list" id="playersList">
          <div style="text-align: center; opacity: 0.7;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ†</div>
        </div>
        <button class="btn-clear" id="clearBtn">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        <h2 style="margin-top: 20px;">â±ï¸ Ù…Ø¯Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Ù†</h2>
        <div class="slider-box">
          <div class="duration-text"><span id="durationVal">5</span> Ø«Ø§Ù†ÙŠØ©</div>
          <input type="range" id="duration" min="1" max="180" value="5">
        </div>
        <button class="btn-spin" id="spinBtn">â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯ÙˆØ±Ø§Ù†</button>
        <div id="messages"></div>
      </div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    const config = {
      apiKey: "AIzaSyAfMcEkpOXgWGE-1d8EVZAJJXXMNeh2thQ",
      authDomain: "luck-wheel-7f514.firebaseapp.com",
      databaseURL: "https://luck-wheel-7f514-default-rtdb.firebaseio.com",
      projectId: "luck-wheel-7f514",
      storageBucket: "luck-wheel-7f514.firebasestorage.app",
      messagingSenderId: "845157453311",
      appId: "1:845157453311:web:c7e9e884c8aa745885ebca"
    };
    const app = initializeApp(config);
    const db = getDatabase(app);
    // DOM
    const loginScreen = document.getElementById('loginScreen');
    const mainScreen = document.getElementById('mainScreen');
    const pwd = document.getElementById('pwd');
    const togglePwd = document.getElementById('togglePwd');
    const loginBtn = document.getElementById('loginBtn');
    const errorMsg = document.getElementById('errorMsg');
    const wheel = document.getElementById('wheel');
    const winnerBox = document.getElementById('winnerBox');
    const winnerName = document.getElementById('winnerName');
    const playersList = document.getElementById('playersList');
    const playerName = document.getElementById('playerName');
    const addBtn = document.getElementById('addBtn');
    const clearBtn = document.getElementById('clearBtn');
    const spinBtn = document.getElementById('spinBtn');
    const duration = document.getElementById('duration');
    const durationVal = document.getElementById('durationVal');
    const viewers = document.getElementById('viewers');
    const players = document.getElementById('players');
    const messages = document.getElementById('messages');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const fileInput = document.getElementById('fileInput');
    let playersData = [];
    let spinDuration = 5;
    let isSpinning = false;
    // Toggle Password
    togglePwd.addEventListener('click', () => {
      if (pwd.type === 'password') {
        pwd.type = 'text';
        togglePwd.textContent = 'ğŸ™ˆ';
      } else {
        pwd.type = 'password';
        togglePwd.textContent = 'ğŸ‘ï¸';
      }
    });
    // Login
    function checkLogin() {
      if (pwd.value === '521988') {
        loginScreen.classList.add('hidden');
        mainScreen.classList.add('visible');
        localStorage.setItem('adminLogged', 'true');
      } else {
        errorMsg.textContent = 'âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©';
        pwd.value = '';
        setTimeout(() => errorMsg.textContent = '', 3000);
      }
    }
    loginBtn.addEventListener('click', checkLogin);
    pwd.addEventListener('keypress', (e) => e.key === 'Enter' && checkLogin());
    if (localStorage.getItem('adminLogged') === 'true') {
      loginScreen.classList.add('hidden');
      mainScreen.classList.add('visible');
    }
    // Duration
    duration.addEventListener('input', () => {
      spinDuration = parseInt(duration.value);
      durationVal.textContent = spinDuration;
    });
    // Firebase Listeners: Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ø§Ù„Ù…ØªÙØ§Ø¹Ù„ÙŠÙ† ÙÙ‚Ø· (active:true)
    onValue(ref(db, 'wheel/viewers'), (snap) => {
      const data = snap.val() || {};
      const activeCount = Object.values(data).filter(v => v.active).length;
      viewers.textContent = activeCount;
    });
    onValue(ref(db, 'wheel/players'), (snap) => {
      const data = snap.val() || {};
      playersData = Object.entries(data).map(([id, p]) => ({id, ...p}));
      players.textContent = playersData.length;
      drawWheel();
      updateList();
    });
    onValue(ref(db, 'wheel/state'), (snap) => {
      const data = snap.val();
      if (data && !isSpinning) {
        isSpinning = true;
        spinWheel(data.rotation, data.duration, data.winner);
        setTimeout(() => isSpinning = false, data.duration * 1000 + 500);
      }
    });
    // Add Player
    addBtn.addEventListener('click', () => {
      const name = playerName.value.trim();
      if (!name) {
        showMsg('âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…', 'error');
        return;
      }
      if (playersData.some(p => p.name.toLowerCase() === name.toLowerCase())) {
        showMsg('âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
        playerName.value = '';
        return;
      }
      set(push(ref(db, 'wheel/players')), {name});
      playerName.value = '';
      showMsg('âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'success');
    });
    // Clear All
    clearBtn.addEventListener('click', () => {
      if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ')) {
        remove(ref(db, 'wheel/players'));
        remove(ref(db, 'wheel/state'));
        showMsg('ğŸ§¹ ØªÙ… Ø§Ù„Ù…Ø³Ø­', 'success');
      }
    });
    // Export
    exportBtn.addEventListener('click', () => {
      if (playersData.length === 0) {
        showMsg('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù…Ø§Ø¡', 'error');
        return;
      }
      const text = playersData.map(p => p.name).join('\n');
      const blob = new Blob([text], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Ù„Ø§Ø¹Ø¨ÙŠÙ†_${new Date().toLocaleDateString('ar-SA')}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      showMsg('âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', 'success');
    });
    // Import
    importBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      const names = text.split('\n').map(n => n.trim()).filter(n => n);
      if (!names.length) {
        showMsg('âš ï¸ Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº', 'error');
        return;
      }
      let added = 0, dup = 0;
      for (const name of names) {
        if (!playersData.some(p => p.name.toLowerCase() === name.toLowerCase())) {
          await set(push(ref(db, 'wheel/players')), {name});
          added++;
        } else dup++;
      }
      showMsg(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ${added} ${dup > 0 ? `(${dup} Ù…ÙƒØ±Ø±)` : ''}`, 'success');
      fileInput.value = '';
    });
    // Spin
    spinBtn.addEventListener('click', async () => {
      if (!playersData.length) {
        showMsg('âš ï¸ Ø£Ø¶Ù Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
      }
      if (isSpinning) {
        showMsg('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Ù†', 'error');
        return;
      }
      spinBtn.disabled = true;
      const winner = playersData[Math.floor(Math.random() * playersData.length)].name;
      const rotation = (10 + Math.random() * 5) * 360 + Math.random() * 360;
      await set(ref(db, 'wheel/state'), {rotation, winner, duration: spinDuration, timestamp: Date.now()});
      setTimeout(() => spinBtn.disabled = false, spinDuration * 1000 + 1000);
    });
    // Draw Wheel
    function drawWheel() {
      if (!playersData.length) return;
      const angle = 360 / playersData.length;
      wheel.innerHTML = '<div class="pointer"></div>';
      playersData.forEach((p, i) => {
        const seg = document.createElement('div');
        seg.className = 'segment';
        seg.style.transform = `rotate(${i * angle}deg)`;
        seg.innerHTML = `<span style="transform:rotate(${-i * angle}deg)">${p.name}</span>`;
        wheel.appendChild(seg);
      });
    }
    function spinWheel(rot, dur, winner) {
      winnerBox.classList.remove('show');
      wheel.style.transition = `transform ${dur}s cubic-bezier(0.33, 1, 0.68, 1)`;
      wheel.style.transform = `rotate(${rot}deg)`;
      setTimeout(() => {
        winnerBox.classList.add('show');
        winnerName.textContent = winner;
        showMsg(`ğŸ‰ Ø§Ù„ÙØ§Ø¦Ø²: ${winner}`, 'success');
      }, dur * 1000);
    }
    function updateList() {
      if (!playersData.length) {
        playersList.innerHTML = '<div style="text-align: center; opacity: 0.7;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ†</div>';
        return;
      }
      playersList.innerHTML = playersData.map(p => `
        <div class="player-item">
          <span>ğŸ‘¤ ${p.name}</span>
          <button class="delete-btn" onclick="delPlayer('${p.id}')">âœ•</button>
        </div>
      `).join('');
    }
    window.delPlayer = (id) => remove(ref(db, `wheel/players/${id}`));
    function showMsg(text, type) {
      messages.innerHTML = `<div class="msg ${type}">${text}</div>`;
      setTimeout(() => messages.innerHTML = '', 3000);
    }
  </script>
</body>
</html>
